// ignore_for_file: avoid_print

import 'dart:io';
import 'package:args/args.dart';

import 'src/git_stamp_build.dart';
import 'src/git_stamp_directory.dart';
import 'src/files/dynamic/git_stamp_dynamic_files.dart';
import 'src/files/static/git_stamp_static_files.dart';

Future<void> main(List<String> arguments) async {
  final parser = ArgParser()
    ..addOption(
      'build-type',
      abbr: 'b',
      allowed: ['lite', 'full', 'custom'],
      defaultsTo: 'lite',
    )
    ..addOption(
      'gen-url-launcher',
      abbr: 'u',
      allowed: ['enabled', 'disabled'],
      defaultsTo: 'disabled',
    )
    ..addMultiOption(
      'gen-only',
      abbr: 'o',
      allowed: [
        'commit-list',
        'diff-list',
        'repo-creation-date',
        'build-branch',
        'build-date-time',
        'build-system-info',
        'repo-path',
        'observed-files-list',
        'app-version',
      ],
      defaultsTo: null,
    )
    ..addFlag(
      'help',
      abbr: 'h',
      negatable: false,
    );

  try {
    final results = parser.parse(arguments);
    if (results['help']) {
      print(parser.usage);
      return;
    }

    /// Args
    final buildType = results['build-type'].toLowerCase();
    final urlLauncher = results['gen-url-launcher'].toLowerCase();
    final List<String>? genOnly = results['gen-only'];

    /// Parse
    final isLiteVersion = buildType == 'lite';
    final generateUrlLauncher = urlLauncher == 'enabled';
    final isCustom = genOnly?.isNotEmpty ?? false;

    /// Generated by: https://patorjk.com/
    const gitStampAscii = r'''
    ┏┓•   ┏┓          ┏┓               
    ┃┓┓╋  ┗┓╋┏┓┏┳┓┏┓  ┃┓┏┓┏┓┏┓┏┓┏┓╋┏┓┏┓
    ┗┛┗┗  ┗┛┗┗┻┛┗┗┣┛  ┗┛┗ ┛┗┗ ┛ ┗┻┗┗┛┛ 
                  ┛                    
    ''';

    print('');
    print(gitStampAscii);
    print('Build Type: ${isCustom ? 'custom ($genOnly)' : buildType}');
    print('Use [url_launcher]: ${generateUrlLauncher ? 'true' : 'false'}');
    print('');

    await GitStampDirectory.recreateDirectories();

    /// custom
    if (isCustom == true) {
      final files = GitStampBuild.custom(genOnly ?? []);
      _generateDataFiles(files, isLiteVersion);
      return;
    }

    /// lite & full
    const files = GitStampBuild.all();
    _generateDataFiles(files, isLiteVersion);
    _generateFlutterInterface(generateUrlLauncher, isLiteVersion);
  } on FormatException catch (e) {
    print(e.message);
    print('Usage: dart run git_stamp [options]');
    print(parser.usage);
    exit(1);
  }
}

void _generateDataFiles(GitStampBuild files, bool isLiteVersion) {
  GitStampNode(files).generate();

  if (files.commitList) {
    GitStampCommit().generate();
    CommitList().generate();
  }

  if (files.diffList) {
    DiffList(isLiteVersion).generate();
  }

  if (files.repoCreationDate) {
    RepoCreationDate().generate();
  }

  if (files.buildBranch) {
    BuildBranch().generate();
  }

  if (files.buildDateTime) {
    BuildDateTime().generate();
  }

  if (files.buildSystemInfo) {
    BuildSystemInfo().generate();
  }

  if (files.repoPath) {
    RepoPath().generate();
  }

  if (files.observedFilesList) {
    ObservedFilesList().generate();
  }

  if (files.appVersion) {
    AppVersion().generate();
  }
}

void _generateFlutterInterface(bool useUrlLauncher, bool isLiteVersion) {
  final gitStampUi = [
    IsLiteVersion(isLiteVersion),
    GitStampPage(),
    GitStampDetailsPage(),
    GitStampUtils(),
    GitStampLauncher(useUrlLauncher),
  ];

  for (var element in gitStampUi) {
    element.generate();
  }
}
